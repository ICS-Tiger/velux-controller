╔═══════════════════════════════════════════════════════════════════════════════╗
║           VELUX ROLLADEN CONTROLLER - KOMPLETTER SCHALTPLAN                   ║
║    ESP32 + 4x BTS7960 + 4x INA219 + Keypad + Relais + RF-Empfänger            ║
╚═══════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════
  ESP32 DEVKIT V1 PINBELEGUNG
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ STROMVERSORGUNG                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ VIN (ESP32)    ──→  12V DC Netzteil (+)                                     │
│ GND (ESP32)    ──→  12V DC Netzteil (-)  [GND COMMON]                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PWM SIGNALE (gemeinsam für alle 4 Motoren)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 25        ──→  RPWM (alle 4x BTS7960 parallel)                         │
│ GPIO 26        ──→  LPWM (alle 4x BTS7960 parallel)                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MOTOR 1 - ENABLE PINS                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 32        ──→  BTS7960 #1  R_EN                                        │
│ GPIO 33        ──→  BTS7960 #1  L_EN                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MOTOR 2 - ENABLE PINS                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 27        ──→  BTS7960 #2  R_EN                                        │
│ GPIO 14        ──→  BTS7960 #2  L_EN                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MOTOR 3 - ENABLE PINS                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 16        ──→  BTS7960 #3  R_EN                                        │
│ GPIO 17        ──→  BTS7960 #3  L_EN                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MOTOR 4 - ENABLE PINS                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 18        ──→  BTS7960 #4  R_EN                                        │
│ GPIO 19        ──→  BTS7960 #4  L_EN                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ I2C BUS (INA219 Stromsensoren)                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 21 (SDA)  ──→  INA219 #1 (0x40) SDA ┐                                  │
│                 ──→  INA219 #2 (0x41) SDA ├─ [I2C BUS]                      │
│                 ──→  INA219 #3 (0x44) SDA │                                 │
│                 ──→  INA219 #4 (0x45) SDA ┘                                 │
│                                                                             │
│ GPIO 22 (SCL)  ──→  INA219 #1 (0x40) SCL ┐                                  │
│                 ──→  INA219 #2 (0x41) SCL ├─ [I2C BUS]                      │
│                 ──→  INA219 #3 (0x44) SCL │                                 │
│                 ──→  INA219 #4 (0x45) SCL ┘                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ANALOGES KEYPAD (16 Tasten)                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 34 (ADC)  ──→  Keypad Output (4x4 Matrix analog)                       │
│                                                                             │
│ Tastenbelegung:                                                             │
│  - Tasten 0-3:  Motoren 1-4 HOCH                                            │
│  - Tasten 4-7:  Motoren 1-4 STOP                                            │
│  - Tasten 8-11: Motoren 1-4 RUNTER                                          │
│  - Taste 12:    Alle HOCH                                                   │
│  - Taste 13:    Alle RUNTER                                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 433 MHz RF-EMPFÄNGER (Funkfernbedienungen)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 35        ──→  RF-Empfänger DATA Pin                                   │
│ 3.3V / 5V      ──→  RF-Empfänger VCC (je nach Modul)                        │
│ GND            ──→  RF-Empfänger GND                                        │
│                                                                             │
│ Features:                                                                   │
│  - 16 anlernbare RF-Codes für alle Funktionen                               │
│  - Speicherung im Flash (bleibt nach Neustart)                              │
│  - 30s Lernmodus-Timeout                                                    │
│  - RCSwitch Library (PT2262, EV1527, HT6P20B kompatibel)                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ RELAIS MOTORSTROMVERSORGUNG (Energiesparmodus)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ GPIO 23        ──→  Relais Steuerung (HIGH = EIN, LOW = AUS)                │
│                                                                             │
│ Anschluss:                                                                  │
│  - Relais schaltet 12V Stromversorgung für alle BTS7960 Module              │
│  - Relais zwischen 12V Netzteil (+) und BTS7960 B+ Eingängen                │
│                                                                             │
│ Timing:                                                                     │
│  - Einschalten: 300ms VOR Motorstart (RELAY_PRE_ON_DELAY_MS)                │
│  - Ausschalten: 20 Sekunden NACH letztem Motor (RELAY_POST_OFF_DELAY_MS)    │
│                                                                             │
│ Empfohlenes Relais:                                                         │
│  - 5V Spulenspannung (vom ESP32 VIN)                                        │
│  - Schaltkontakt min. 10A @ 12V DC                                          │
│  - Mit Freilaufdiode!                                                       │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  BTS7960 MOTOR DRIVER MODULE (4x identisch)
═══════════════════════════════════════════════════════════════════════════════

Jedes BTS7960 Modul steuert 1 Motor:

┌──────────────────────────────────────────────────────────────────────────┐
│  BTS7960 MODULE #X                                                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  EINGANG (vom ESP32):                                                    │
│  ├─ VCC (5V)   ──→  ESP32 VIN (oder extern 5V)                           │
│  ├─ GND        ──→  GND COMMON                                           │
│  ├─ RPWM       ──→  ESP32 GPIO 25 (alle parallel!)                       │
│  ├─ LPWM       ──→  ESP32 GPIO 26 (alle parallel!)                       │
│  ├─ R_EN       ──→  ESP32 GPIO XX (Motor-spezifisch)                     │
│  └─ L_EN       ──→  ESP32 GPIO XX (Motor-spezifisch)                     │
│                                                                          │
│  MOTOR POWER:                                                            │
│  ├─ B+         ──→  12V DC (+)  [von Netzteil]                           │
│  └─ B-         ──→  GND         [von Netzteil]                           │
│                                                                          │
│  MOTOR OUTPUT:                                                           │
│  ├─ M+         ──→  INA219 V+ (VIN+)                                     │
│  │                  │                                                    │
│  │                  └─► INA219 V- (VOUT+) ──→ Motor Pol 1 (+)            │
│  │                                                                       │
│  └─ M-         ◄──  Motor Pol 2 (-)                                      │
│                                                                          │
│  INA219 Strommessung:                                                   │
│  - INA219 V+ (VIN+)  misst vom BTS7960 M+                                │
│  - INA219 V- (VOUT+) geht zum Motor +                                    │
│  - Motor - geht zurück zu BTS7960 M-                                     │
│                                                                          │
│  WICHTIG: Strommessung erfolgt im PLUS-Zweig zwischen BTS und Motor!    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  INA219 STROMSENSOR MODULE (4x identisch)
═══════════════════════════════════════════════════════════════════════════════

Jedes INA219 Modul misst den Strom für 1 Motor:

┌──────────────────────────────────────────────────────────────────────────┐
│  INA219 MODULE #X                                                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  EINGANG (I2C):                                                          │
│  ├─ VCC        ──→  3.3V (ESP32)                                         │
│  ├─ GND        ──→  GND COMMON                                           │
│  ├─ SDA        ──→  ESP32 GPIO 21 (I2C Bus)                              │
│  └─ SCL        ──→  ESP32 GPIO 22 (I2C Bus)                              │
│                                                                          │
│  I2C ADRESSEN:                                                           │
│  ├─ INA219 #1  =  0x40  (Motor 1)                                        │
│  ├─ INA219 #2  =  0x41  (Motor 2)                                        │
│  ├─ INA219 #3  =  0x44  (Motor 3)                                        │
│  └─ INA219 #4  =  0x45  (Motor 4)                                        │
│                                                                          │
│  STROMMESSUNG (im Motor-Kreislauf):                                      │
│  ├─ V+ (VIN+)  ──→  BTS7960 M+                                            │
│  └─ V- (VOUT+) ──→  Motor Pol 1 (+)                                      │
│                                                                          │
│  Stromfluss:                                                             │
│  BTS7960 M+ → INA219 V+ → INA219 V- → Motor+ → Motor- → BTS7960 M-      │
│                                                                          │
│  ADRESSIERUNG (Löt-Jumper):                                              │
│  ├─ 0x40: keine Jumper                                                   │
│  ├─ 0x41: A0 geschlossen                                                 │
│  ├─ 0x44: A1 geschlossen                                                 │
│  └─ 0x45: A0 + A1 geschlossen                                            │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  KOMPLETTE VERDRAHTUNG PRO MOTOR (Beispiel Motor 1)
═══════════════════════════════════════════════════════════════════════════════

                           ┌────────────┐
                           │  ESP32     │
                           │            │
         ┌─────────────────┤ GPIO 25    │ (RPWM zu allen BTS7960)
         │  ┌──────────────┤ GPIO 26    │ (LPWM zu allen BTS7960)
         │  │  ┌───────────┤ GPIO 32    │ (M1 R_EN)
         │  │  │  ┌────────┤ GPIO 33    │ (M1 L_EN)
         │  │  │  │  ┌─────┤ GPIO 21    │ (SDA zu allen INA219)
         │  │  │  │  │  ┌──┤ GPIO 22    │ (SCL zu allen INA219)
         │  │  │  │  │  │  └────────────┘
         │  │  │  │  │  │
         │  │  │  │  │  │  ┌────────────┐
         │  │  │  │  │  └──┤ SDA        │
         │  │  │  │  └─────┤ SCL   INA  │
         │  │  │  │        │ 0x40  219  │
         │  │  │  │        │ VCC  3.3V  │
         │  │  │  │        │ GND  GND   │
         │  │  │  │        └────────────┘
         │  │  │  │
         │  │  │  │        ┌────────────┐
         │  │  │  │        │  BTS7960   │
         │  │  │  │        │            │
         ├──┼──┼──┼────────┤ RPWM       │
         │  └──┼──┼────────┤ LPWM       │
         │     └──┼────────┤ R_EN       │
         │        └────────┤ L_EN       │
         │                 │            │
         │                 │ B+  12V ◄──┼───── 12V Netzteil (+)
         │                 │ B-  GND ───┼───── GND
         │                 │            │
         │                 │ M+ ────────┼──┐
         │                 │            │  │  INA219 Strommessung
         │                 │            │  │  ┌─────────────┐
         │                 │            │  └──┤ V+ (VIN+)   │
         │                 │            │     │             │
         │                 │            │     │ V- (VOUT+)  │────┐
         │                 │            │     └─────────────┘    │
         │                 │            │                        │
         │                 │            │     ┌─────────┐        │
         │                 │            │     │ MOTOR 1 │        │
         │                 │            │     │         │        │
         │                 │            │     │ +  ◄────┼────────┘
         │                 │            │     │         │
         │                 │            │     │ -  ─────┼───┐
         │                 │            │     └─────────┘   │
         │                 │ M- ◄───────┼───────────────────┘
         │                 └────────────┘
         │
         └─ HINWEIS: Strommessung im PLUS-Zweig!
            BTS M+ → INA V+ → INA V- → Motor+ → Motor- → BTS M-


═══════════════════════════════════════════════════════════════════════════════
  ANALOGES KEYPAD (4x4 Matrix - 16 Tasten)
═══════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────┐
│  KEYPAD MODUL                                                            │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Anschluss:                                                              │
│  ├─ VCC        ──→  3.3V (ESP32)                                         │
│  ├─ GND        ──→  GND COMMON                                           │
│  └─ OUT        ──→  ESP32 GPIO 34 (ADC1_CH6)                             │
│                                                                          │
│  Funktionen (16 Tasten):                                                 │
│  ├─ 0-3:    Motor 1-4 AUF                                                │
│  ├─ 4-7:    Motor 1-4 ZU                                                 │
│  ├─ 8-11:   Motor 1-4 STOP                                               │
│  ├─ 12:     Alle AUF                                                     │
│  ├─ 13:     Alle ZU                                                      │
│  └─ 14-15:  Reserve                                                      │
│                                                                          │
│  Funktionsweise:                                                         │
│  - Jede Taste hat einen eigenen Widerstandswert                          │
│  - ESP32 liest analoge Spannung (0-3.3V)                                 │
│  - Software erkennt Taste anhand Spannungswert                           │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  STROMVERSORGUNG - GESAMT SCHEMA
═══════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   230V AC                                                                │
│     │                                                                    │
│     └──► [Netzteil 12V DC / 10A+]                                        │
│              │                                                           │
│              ├──► ESP32 VIN                                              │
│              ├──► BTS7960 #1  B+                                         │
│              ├──► BTS7960 #2  B+                                         │
│              ├──► BTS7960 #3  B+                                         │
│              ├──► BTS7960 #4  B+                                         │
│              │                                                           │
│              └──► GND COMMON ────┬─── ESP32 GND                          │
│                                  ├─── BTS7960 #1 B-                      │
│                                  ├─── BTS7960 #2 B-                      │
│                                  ├─── BTS7960 #3 B-                      │
│                                  ├─── BTS7960 #4 B-                      │
│                                  ├─── INA219 #1 GND                      │
│                                  ├─── INA219 #2 GND                      │
│                                  ├─── INA219 #3 GND                      │
│                                  ├─── INA219 #4 GND                      │
│                                  └─── Keypad GND                         │
│                                                                          │
│   ESP32 3.3V ────┬─── INA219 #1 VCC                                      │
│                  ├─── INA219 #2 VCC                                      │
│                  ├─── INA219 #3 VCC                                      │
│                  ├─── INA219 #4 VCC                                      │
│                  └─── Keypad VCC                                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  TECHNISCHE HINWEISE
═══════════════════════════════════════════════════════════════════════════════

1. NETZTEIL:
   - Mindestens 12V DC / 10A (besser 15A)
   - 4 Motoren @ max. 3A = 12A Spitzenlast
   - Empfehlung: Meanwell LRS-150-12 (12V/12.5A)

2. GEMEINSAME MASSE (GND):
   - ALLE GND müssen verbunden sein!
   - ESP32, BTS7960, INA219, Keypad, Netzteil
   - Dicke Kabel für Motorstrom (min. 1.5mm²)

3. I2C BUS:
   - Pull-up Widerstände meist auf INA219 vorhanden
   - Falls Probleme: 4.7kΩ zwischen SDA/SCL und 3.3V

4. INA219 ADRESSIERUNG:
   - Jeder Sensor braucht eigene Adresse!
   - Löt-Jumper auf Rückseite:
     * Motor 1 (0x40): keine Jumper
     * Motor 2 (0x41): A0 schließen
     * Motor 3 (0x44): A1 schließen
     * Motor 4 (0x45): A0 + A1 schließen

5. PWM VERKABELUNG:
   - RPWM/LPWM zu ALLEN 4x BTS7960 parallel
   - Enable-Pins individuell pro Motor
   - Ermöglicht gemeinsame PWM-Steuerung + individuelle Motor-Auswahl

6. STROMMESSUNG:
   - INA219 V+ und V- in Serie mit Motor
   - Misst Strom zwischen BTS7960 M- und Motor-Pol
   - Überstromschutz bei >3A für >500ms

7. MOTOREN:
   - 12V DC Getriebemotoren
   - Max. 3A pro Motor (Dauerlast)
   - Spitzenstrom beim Anlauf berücksichtigen

8. SICHERHEIT:
   - Freilaufdioden meist im BTS7960 integriert
   - Software-Überstromschutz aktiv
   - Hardware-Strombegrenzung im BTS7960

═══════════════════════════════════════════════════════════════════════════════
